# VVS02 - WebApp Integration Tests Report

## Introduction

## End-to-end Testing

Five key test narratives were implemented using HtmlUnit inside the test class `HtmlUnitTests.java` of the package `vvs_webapp` to end-to-end test the SUT.

### Test Architecture

All tests share:
- a WebClient configuration
- a reference to the `index.html` page
- and helper methods for common operations (adding/removing customers, creating sales, etc.)

Each test follows the same pattern:
- set up the necessary preconditions
- perform the actions being tested
- verify the intermediary steps and results with assertions
- clean up by removing any test data to leave the database in its original state

### 1. Adding Addresses to Existing Customer
**Method:** `addTwoAddressesToCustomerTest()`
- Retrieves an existing customer's VAT number
- Gets initial count of customer addresses
- Adds two new addresses with predefined data
- Verifies the address table now includes both new addresses
- Confirms the total row count increased by exactly two

### 2. Customer Insertion
**Method:** `insertTwoCustomersTest()`
- Adds two new customers with VAT, designation, and phone details
- Navigates to the "List All Customers" page
- Verifies all customer information appears correctly in the list
- Cleans up by removing the test customers

### 3. Sale Creation
**Method:** `insertSaleTest()`
- Creates a temporary customer
- Adds a new sale for this customer
- Verifies the sale appears with status "O" (Open)
- Confirms the sale is properly associated with the customer's VAT number
- Cleans up by removing the temporary customer

### 4. Sale Closure
**Method:** `closeSaleTest()`
- Creates a temporary customer
- Adds a new sale to the customer
- Retrieves the sale ID
- Closes the sale
- Verifies the sale status changes to "C" (Closed)
- Cleans up by removing the temporary customer

### 5. Delivery Creation
**Method:** `insertDeliveryTest()`
- Creates a new customer with complete details
- Adds an address to the customer
- Creates a new sale for the customer
- Navigates to the delivery creation page
- Retrieves the previously inserted sale ID and address ID
- Creates a delivery connecting the sale and address
- Verifies the delivery appears correctly in the delivery table


## Database Testing

Three test classes were implemented using DbSetup to test the database operations: `CustomersDBTest`, `SalesDBTest`, and `SaleDeliveriesDBTest`. The tests are supported by a utility class `DBSetupUtils` that handles database setup and provides common operations.

### Database Setup

The `DBSetupUtils` class provides:
- Constants for database connection
- Operations for cleaning the database (`DELETE_ALL`)
- Predefined test data including customers, sales, addresses, and deliveries
- Combined operations like `INSERT_CUSTOMER_SALE_DATA`, `INSERT_CUSTOMER_ADDRESS_DATA` and `INSERT_CUSTOMER_ADDRESS_SALE_DATA`

Each test class uses a similar setup strategy:
- `@BeforeAll`: Connects to the test database
- `@BeforeEach`: Resets the database and loads appropriate test data

### Customer Tests

**Method:** `addCustomerWithExistingVATTest()`

Tests that the SUT prevents adding a customer with an existing VAT number
1. Retrieves all existing customers
2. Attempts to add each customer again with the same data
3. Verifies that an `ApplicationException` is thrown for each attempt

**Method:** `updateCustomerContactTest()`

Tests that customer contact information is properly updated
1. Retrieves all existing customers
2. Updates the phone number for all customers to a new value
3. Verifies that all customers now have the new phone number

**Method:** `deleteAllCustomersTest()`

Tests that deleting all customers results in an empty customer list
1. Retrieves all existing customers
1. Deletes all customers one by one
2. Verifies that the customer list is empty after deletion

**Method:** `deleteCustomerTest()`

Tests that a deleted customer can be added back without exceptions
1. Saves the initial list of customers
2. Deletes all customers and verifies the list is empty
3. Adds all customers back with their original information
4. Verifies that the number of customers matches the initial count

---
### Sales Tests

**Method:** `deleteCustomerSalesAreDeletedTest()`

Tests that deleting a customer also removes its associated sales
1. Verifies that a specific customer exists and has sales
2. Deletes the customer
3. Confirms the customer no longer exists
4. Verifies that no sales remain for that customer's VAT number

**Method:** `addSaleIncreasesSalesNumberTest()`

Tests that adding a sale increases the total count by one
1. Gets the initial count of all sales
2. Adds a new sale for an existing customer
3. Verifies that the total count has increased by exactly one

**Method:** `newSaleHasOpenStatusTest()`

Tests that a newly created sale has the "Open" status ('O')
1. Creates a new sale for an existing customer
2. Retrieves the sales for that customer
3. Verifies that the most recent sale has status 'O'

**Method:** `newSaleHasZeroTotalTest()`

Tests that a newly created sale has a total of 0.0
1. Creates a new sale for an existing customer
2. Retrieves the sales for that customer
3. Verifies that the most recent sale has a total of 0.0

---
### Sale Deliveries Tests

**Method:** `getSaleDeliveriesForCustomerTest()`
- Tests retrieval of sale deliveries for a specific customer
- Verifies that the expected number of deliveries (2) are returned

**Method:** `addNewSaleDeliveryTest()`
- Tests adding a new delivery for a sale
- Gets an existing sale and address for a customer
- Records the initial number of deliveries
- Adds a new sale delivery
- Verifies that the number of deliveries has increased by one

The DbSetup tests effectively verify the database operations, ensuring that the persistence layer of the application functions correctly and maintains data integrity. Each test focuses on a specific behavior of the SUT, following good testing practices by checking only one aspect per test method.


## Mockito

## Back Log

## Sut Modifications

Mudança no create e drop da DB para adicionar ON DELETE CASCADE

Entre outras modificações já faladas anteriormente, foram adicionalmente feitas as seguintes mudanças para facilitar a obtenção de elementos HTML presentes em páginas nos testes de HtmlUnit:
1.	added ' id="addressesTable" ' to CustomerInfo.jsp address table
2.	added ' id="addressesTable" ' to addSaleDelivery.jsp address table
3.	added ' id="salesTable" ' to SalesInfo.jsp sales table
4.	added ' id="salesTable" ' to CloseSale.jsp sales table
5.	added ' id="salesTable" ' to addSaleDelivery.jsp sales table
6.	added ' id="salesDeliveryTable" ' to ShowSalesDelivery.jsp sales delivery table
7.	added ' id="salesDeliveryTable" ' to SalesDeliveryInfo.jsp sales delivery table 
